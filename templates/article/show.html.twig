{% extends 'base.html.twig' %}

{% block body_id 'article_show' %}

{% block main %}
    <h1>{{ article.title }}</h1>

    <div class="article-metadata">
        {# Hero Media Section #}
        {% if article.images is not empty or article.videos is not empty %}
            <div class="mb-4">
                {% if article.images is not empty %}
                    {# Show Image Carousel #}
                    <div id="articleCarousel" class="carousel slide carousel-fade mb-4" data-bs-ride="carousel">
                        <div class="carousel-inner rounded shadow-sm">
                            {% for image in article.images %}
                                <div class="carousel-item {{ loop.first ? 'active' : '' }}">
                                    <img src="{{ vich_uploader_asset(image, 'file') }}" class="d-block w-100 object-fit-cover" style="max-height: 500px;" alt="{{ image.caption }}">
                                    {% if image.caption %}
                                        <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-75 rounded py-2 px-3 bottom-0 mb-4 mx-auto w-auto" style="left: 50%; transform: translateX(-50%);">
                                            <p class="mb-0 small">{{ image.caption }}</p>
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>
                        {% if article.images|length > 1 %}
                            <button class="carousel-control-prev" type="button" data-bs-target="#articleCarousel" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#articleCarousel" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        {% endif %}
                    </div>
                {% endif %}

                {# Video Gallery #}
                {% if article.videos is not empty %}
                    <div class="row g-3">
                        {% for video in article.videos %}
                            <div class="{{ article.videos|length == 1 ? 'col-12' : 'col-md-6' }}">
                                <div class="ratio ratio-16x9 rounded shadow-sm overflow-hidden">
                                    <iframe src="{{ video.url|replace({'watch?v=': 'embed/'}) }}" title="{{ video.caption }}" allowfullscreen></iframe>
                                </div>
                                {% if video.caption %}
                                    <p class="text-muted small text-center mt-2">{{ video.caption }}</p>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        {% endif %}

        <p class="article-metadata border-top pt-3 mt-3">
            <span class="metadata me-3"><twig:ux:icon name="tabler:calendar-time"/> {{ article.publishedAt|format_datetime('medium', 'medium') }}</span>
            <span class="metadata me-3"><twig:ux:icon name="tabler:user"/> {{ article.author.fullName }}</span>
            <span class="metadata"><twig:ux:icon name="tabler:folder"/> {{ article.category.name|trans }}</span>
        </p>
    </div>

    {{ article.content|markdown_to_html|sanitize_html }}

    {{ include('article/_article_tags.html.twig') }}

    <div id="post-add-comment" class="well">
        {#
            The 'IS_AUTHENTICATED_FULLY' role ensures that the user has entered
            their credentials (login + password) during this session. If they
            are automatically logged via the 'Remember Me' functionality, they won't
            be able to add a comment.
            See https://symfony.com/doc/current/security/remember_me.html#forcing-the-user-to-re-authenticate-before-accessing-certain-resources
        #}
        {% if is_granted('IS_AUTHENTICATED_FULLY') %}
            {#
                When the name of the Twig argument is the same as the name of the variable, you can omit it.
                e.g. instead of controller('...', {post: post}) you can use controller('...', {post})
            #}
            {{ render(controller('App\\Controller\\ArticleController::commentForm', {article})) }}
        {% else %}
            <p>
                <a class="btn btn-success" href="{{ path('security_login', {redirect_to: app.request.pathInfo}) }}">
                    <twig:ux:icon name="tabler:login"/> {{ 'action.sign_in'|trans }}
                </a>
                {{ 'post.to_publish_a_comment'|trans }}
            </p>
        {% endif %}
    </div>

    <h3>
        <twig:ux:icon name="tabler:messages"/> {{ 'post.num_comments'|trans({count: article.comments|length}) }}
    </h3>

    {% for comment in article.comments %}
        <div class="row post-comment">
            <a name="comment_{{ comment.id }}"></a>
            <h4 class="col-sm-3">
                <strong>{{ comment.author.fullName }}</strong> {{ 'post.commented_on'|trans }}
                {#
                    It's not mandatory to set the timezone in format_datetime(). This is done to
                    avoid errors when the 'intl' PHP extension is not available and the application
                    is forced to use the limited "intl polyfill", which only supports UTC and GMT
                #}
                <strong>{{ comment.publishedAt|format_datetime('medium', 'short', '', 'UTC') }}</strong>
            </h4>
            <div class="col-sm-9">
                {{ comment.content|markdown_to_html|sanitize_html }}
            </div>
        </div>
    {% else %}
        <div class="post-comment">
            <p>{{ 'post.no_comments'|trans }}</p>
        </div>
    {% endfor %}
{% endblock %}

{% block sidebar %}
    {% if is_granted('edit', article) %}
        <div class="section">
            <a class="btn btn-lg btn-block btn-success" href="{{ path('admin_article_edit', {id: article.id}) }}">
                <twig:ux:icon name="tabler:pencil"/> {{ 'action.edit_post'|trans }}
            </a>
        </div>
    {% endif %}

    {#
        The parent() function includes the contents defined by the parent template
        ('base.html.twig') for this block ('sidebar'). This is a very convenient way
        to share common contents in different templates
    #}
    {{ parent() }}

    {{ show_source_code(_self) }}
    {{ include('article/_rss.html.twig') }}
{% endblock %}
